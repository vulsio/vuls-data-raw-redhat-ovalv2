{
	"id": "oval:com.redhat.cve:def:202147209",
	"version": "636",
	"class": "vulnerability",
	"metadata": {
		"title": "kernel: sched/fair: Prevent dead task groups from regaining cfs_rq's (moderate)",
		"reference": [
			{
				"ref_id": "CVE-2021-47209",
				"ref_url": "https://access.redhat.com/security/cve/CVE-2021-47209",
				"source": "CVE"
			}
		],
		"description": "DOCUMENTATION: The MITRE CVE dictionary describes this issue as: In the Linux kernel, the following vulnerability has been resolved:\n\nsched/fair: Prevent dead task groups from regaining cfs_rq's\n\nKevin is reporting crashes which point to a use-after-free of a cfs_rq\nin update_blocked_averages(). Initial debugging revealed that we've\nlive cfs_rq's (on_list=1) in an about to be kfree()'d task group in\nfree_fair_sched_group(). However, it was unclear how that can happen.\n\nHis kernel config happened to lead to a layout of struct sched_entity\nthat put the 'my_q' member directly into the middle of the object\nwhich makes it incidentally overlap with SLUB's freelist pointer.\nThat, in combination with SLAB_FREELIST_HARDENED's freelist pointer\nmangling, leads to a reliable access violation in form of a #GP which\nmade the UAF fail fast.\n\nMichal seems to have run into the same issue[1]. He already correctly\ndiagnosed that commit a7b359fc6a37 (\"sched/fair: Correctly insert\ncfs_rq's to list on unthrottle\") is causing the preconditions for the\nUAF to happen by re-adding cfs_rq's also to task groups that have no\nmore running tasks, i.e. also to dead ones. His analysis, however,\nmisses the real root cause and it cannot be seen from the crash\nbacktrace only, as the real offender is tg_unthrottle_up() getting\ncalled via sched_cfs_period_timer() via the timer interrupt at an\ninconvenient time.\n\nWhen unregister_fair_sched_group() unlinks all cfs_rq's from the dying\ntask group, it doesn't protect itself from getting interrupted. If the\ntimer interrupt triggers while we iterate over all CPUs or after\nunregister_fair_sched_group() has finished but prior to unlinking the\ntask group, sched_cfs_period_timer() will execute and walk the list of\ntask groups, trying to unthrottle cfs_rq's, i.e. re-add them to the\ndying task group. These will later -- in free_fair_sched_group() -- be\nkfree()'ed while still being linked, leading to the fireworks Kevin\nand Michal are seeing.\n\nTo fix this race, ensure the dying task group gets unlinked first.\nHowever, simply switching the order of unregistering and unlinking the\ntask group isn't sufficient, as concurrent RCU walkers might still see\nit, as can be seen below:\n\n    CPU1:                                      CPU2:\n      :                                        timer IRQ:\n      :                                          do_sched_cfs_period_timer():\n      :                                            :\n      :                                            distribute_cfs_runtime():\n      :                                              rcu_read_lock();\n      :                                              :\n      :                                              unthrottle_cfs_rq():\n    sched_offline_group():                             :\n      :                                                walk_tg_tree_from(…,tg_unthrottle_up,…):\n      list_del_rcu(&tg->list);                           :\n (1)  :                                                  list_for_each_entry_rcu(child, &parent->children, siblings)\n      :                                                    :\n (2)  list_del_rcu(&tg->siblings);                         :\n      :                                                    tg_unthrottle_up():\n      unregister_fair_sched_group():                         struct cfs_rq *cfs_rq = tg->cfs_rq[cpu_of(rq)];\n        :                                                    :\n        list_del_leaf_cfs_rq(tg->cfs_rq[cpu]);               :\n        :                                                    :\n        :                                                    if (!cfs_rq_is_decayed(cfs_rq) || cfs_rq->nr_running)\n (3)    :                                                        list_add_leaf_cfs_rq(cfs_rq);\n      :                                                      :\n      :                                                    :\n      :                                                  :\n      :                                                :\n      :                           \n---truncated---",
		"advisory": {
			"from": "secalert@redhat.com",
			"severity": "Moderate",
			"updated": {
				"date": "2024-04-11"
			},
			"cve": [
				{
					"text": "CVE-2021-47209",
					"cvss3": "5.5/CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H",
					"href": "https://access.redhat.com/security/cve/CVE-2021-47209",
					"impact": "moderate",
					"public": "20240410"
				}
			],
			"affected": {
				"resolution": [
					{
						"state": "Out of support scope",
						"component": [
							"kernel",
							"kernel-abi-whitelists",
							"kernel-bootwrapper",
							"kernel-debug",
							"kernel-debug-devel",
							"kernel-devel",
							"kernel-doc",
							"kernel-firmware",
							"kernel-headers",
							"kernel-kdump",
							"kernel-kdump-devel",
							"perf",
							"python-perf"
						]
					}
				]
			},
			"affected_cpe_list": {
				"cpe": [
					"cpe:/a:redhat:rhel_extras:6",
					"cpe:/a:redhat:rhel_extras_hpn:6",
					"cpe:/a:redhat:rhel_extras_oracle_java:6",
					"cpe:/a:redhat:rhel_extras_sap:6",
					"cpe:/a:redhat:rhel_extras_sap_hana:6",
					"cpe:/o:redhat:enterprise_linux:6",
					"cpe:/o:redhat:enterprise_linux:6::client",
					"cpe:/o:redhat:enterprise_linux:6::computenode",
					"cpe:/o:redhat:enterprise_linux:6::server",
					"cpe:/o:redhat:enterprise_linux:6::workstation"
				]
			},
			"issued": {}
		},
		"affected": {}
	},
	"criteria": {
		"operator": "OR",
		"criterias": [
			{
				"operator": "AND",
				"criterias": [
					{
						"operator": "OR",
						"criterias": [
							{
								"operator": "AND",
								"criterions": [
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764011",
										"comment": "kernel is installed"
									},
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764012",
										"comment": "kernel is signed with Red Hat redhatrelease2 key"
									}
								]
							},
							{
								"operator": "AND",
								"criterions": [
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764023",
										"comment": "kernel-firmware is installed"
									},
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764024",
										"comment": "kernel-firmware is signed with Red Hat redhatrelease2 key"
									}
								]
							},
							{
								"operator": "AND",
								"criterions": [
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764017",
										"comment": "kernel-doc is installed"
									},
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764018",
										"comment": "kernel-doc is signed with Red Hat redhatrelease2 key"
									}
								]
							},
							{
								"operator": "AND",
								"criterions": [
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764003",
										"comment": "kernel-debug-devel is installed"
									},
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764004",
										"comment": "kernel-debug-devel is signed with Red Hat redhatrelease2 key"
									}
								]
							},
							{
								"operator": "AND",
								"criterions": [
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764007",
										"comment": "kernel-abi-whitelists is installed"
									},
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764008",
										"comment": "kernel-abi-whitelists is signed with Red Hat redhatrelease2 key"
									}
								]
							},
							{
								"operator": "AND",
								"criterions": [
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764013",
										"comment": "kernel-kdump is installed"
									},
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764014",
										"comment": "kernel-kdump is signed with Red Hat redhatrelease2 key"
									}
								]
							},
							{
								"operator": "AND",
								"criterions": [
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764005",
										"comment": "kernel-headers is installed"
									},
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764006",
										"comment": "kernel-headers is signed with Red Hat redhatrelease2 key"
									}
								]
							},
							{
								"operator": "AND",
								"criterions": [
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764019",
										"comment": "kernel-bootwrapper is installed"
									},
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764020",
										"comment": "kernel-bootwrapper is signed with Red Hat redhatrelease2 key"
									}
								]
							},
							{
								"operator": "AND",
								"criterions": [
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764025",
										"comment": "perf is installed"
									},
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764026",
										"comment": "perf is signed with Red Hat redhatrelease2 key"
									}
								]
							},
							{
								"operator": "AND",
								"criterions": [
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764001",
										"comment": "kernel-kdump-devel is installed"
									},
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764002",
										"comment": "kernel-kdump-devel is signed with Red Hat redhatrelease2 key"
									}
								]
							},
							{
								"operator": "AND",
								"criterions": [
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764021",
										"comment": "python-perf is installed"
									},
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764022",
										"comment": "python-perf is signed with Red Hat redhatrelease2 key"
									}
								]
							},
							{
								"operator": "AND",
								"criterions": [
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764009",
										"comment": "kernel-debug is installed"
									},
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764010",
										"comment": "kernel-debug is signed with Red Hat redhatrelease2 key"
									}
								]
							},
							{
								"operator": "AND",
								"criterions": [
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764015",
										"comment": "kernel-devel is installed"
									},
									{
										"test_ref": "oval:com.redhat.cve:tst:20072764016",
										"comment": "kernel-devel is signed with Red Hat redhatrelease2 key"
									}
								]
							}
						]
					}
				],
				"criterions": [
					{
						"test_ref": "oval:com.redhat.cve:tst:20022439069",
						"comment": "Red Hat Enterprise Linux 6 is installed"
					}
				]
			}
		],
		"criterions": [
			{
				"test_ref": "oval:com.redhat.cve:tst:20022439070",
				"comment": "Red Hat Enterprise Linux must be installed"
			}
		]
	}
}
